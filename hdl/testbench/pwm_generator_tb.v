// Testbench for pwm_generator module
// Verifies 8-bit PWM signal generation with 7 test cases
// Generated by Claude Code
// Date: 2026-01-17

`timescale 1ns/1ps

module pwm_generator_tb;

    // Clock and reset
    reg clk;
    reg rst;
    reg [7:0] duty;
    wire pwm_out;

    // Test measurement variables
    integer cycle_count;
    integer high_count;
    real measured_duty;
    integer test_failures;
    reg measuring;

    // Instantiate the PWM generator
    pwm_generator dut (
        .clk(clk),
        .rst(rst),
        .duty(duty),
        .pwm_out(pwm_out)
    );

    // Clock generation: 10MHz = 100ns period
    initial begin
        clk = 0;
        forever #50 clk = ~clk;  // Toggle every 50ns
    end

    // Duty cycle measurement logic
    always @(posedge clk) begin
        if (!rst && measuring) begin
            cycle_count = cycle_count + 1;
            if (pwm_out) begin
                high_count = high_count + 1;
            end
        end
    end

    // Main test sequence
    initial begin
        $display("=== PWM Generator Testbench Start ===");
        $display("Clock: 10MHz (100ns period)");
        $display("PWM Period: 256 cycles = 25.6us");
        $display("PWM Frequency: 39.06kHz");
        $display("");

        // Initialize
        rst = 1;
        duty = 8'd0;
        test_failures = 0;
        measuring = 0;
        cycle_count = 0;
        high_count = 0;

        // ========================================
        // TC001: Reset Operation
        // ========================================
        $display("--- TC001: Reset Operation ---");
        #200;  // Wait 2 clock cycles

        if (pwm_out == 1'b0) begin
            $display("  PASS: pwm_out = 0 during reset");
        end else begin
            $display("  FAIL: pwm_out = %b during reset (expected 0)", pwm_out);
            test_failures = test_failures + 1;
        end

        // Release reset
        #100;
        rst = 0;
        #200;

        if (pwm_out == 1'b0) begin
            $display("  PASS: pwm_out = 0 after reset (duty=0)");
        end else begin
            $display("  FAIL: pwm_out = %b after reset", pwm_out);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC002: duty=0 (0% duty cycle)
        // ========================================
        $display("--- TC002: duty=0 (0%% duty cycle) ---");
        duty = 8'd0;
        cycle_count = 0;
        high_count = 0;
        measuring = 1;

        // Run for 2 complete PWM periods (512 cycles = 51.2us)
        #51200;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("  Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        if (high_count == 0) begin
            $display("  PASS: pwm_out stayed LOW throughout (0%% duty)");
        end else begin
            $display("  FAIL: Expected 0 high cycles, got %0d", high_count);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC003: duty=255 (100% duty cycle)
        // ========================================
        $display("--- TC003: duty=255 (100%% duty cycle) ---");
        duty = 8'd255;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change to take effect
        measuring = 1;

        // Run for 2 complete PWM periods (512 cycles = 51.2us)
        #51200;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("  Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        // Allow 1-2 cycles tolerance for boundary conditions
        if (high_count >= 510 && high_count <= 512) begin
            $display("  PASS: pwm_out stayed HIGH throughout (~100%% duty)");
        end else begin
            $display("  FAIL: Expected ~512 high cycles, got %0d", high_count);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC004: duty=64 (25% duty cycle)
        // ========================================
        $display("--- TC004: duty=64 (25%% duty cycle) ---");
        duty = 8'd64;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change
        measuring = 1;

        // Run for 2 complete PWM periods (512 cycles = 51.2us)
        #51200;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("  Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        // Verify: 24% <= measured_duty <= 26%
        if (measured_duty >= 24.0 && measured_duty <= 26.0) begin
            $display("  PASS: Duty cycle within tolerance (24-26%%)");
        end else begin
            $display("  FAIL: Duty cycle %.2f%% out of range (expected 24-26%%)", measured_duty);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC005: duty=128 (50% duty cycle)
        // ========================================
        $display("--- TC005: duty=128 (50%% duty cycle) ---");
        duty = 8'd128;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change
        measuring = 1;

        // Run for 2 complete PWM periods (512 cycles = 51.2us)
        #51200;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("  Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        // Verify: 49% <= measured_duty <= 51%
        if (measured_duty >= 49.0 && measured_duty <= 51.0) begin
            $display("  PASS: Duty cycle within tolerance (49-51%%)");
        end else begin
            $display("  FAIL: Duty cycle %.2f%% out of range (expected 49-51%%)", measured_duty);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC006: duty=192 (75% duty cycle)
        // ========================================
        $display("--- TC006: duty=192 (75%% duty cycle) ---");
        duty = 8'd192;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change
        measuring = 1;

        // Run for 2 complete PWM periods (512 cycles = 51.2us)
        #51200;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("  Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        // Verify: 74% <= measured_duty <= 76%
        if (measured_duty >= 74.0 && measured_duty <= 76.0) begin
            $display("  PASS: Duty cycle within tolerance (74-76%%)");
        end else begin
            $display("  FAIL: Duty cycle %.2f%% out of range (expected 74-76%%)", measured_duty);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // TC007: Dynamic Duty Change
        // ========================================
        $display("--- TC007: Dynamic Duty Change ---");

        // Phase 1: duty=128 (50%)
        $display("  Phase 1: duty=128 (50%%)");
        duty = 8'd128;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change
        measuring = 1;

        // Run for 1 complete PWM period (256 cycles = 25.6us)
        #25600;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("    Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        if (measured_duty >= 49.0 && measured_duty <= 51.0) begin
            $display("    PASS: Phase 1 duty cycle within tolerance (49-51%%)");
        end else begin
            $display("    FAIL: Phase 1 duty cycle %.2f%% out of range", measured_duty);
            test_failures = test_failures + 1;
        end

        // Phase 2: duty=64 (25%)
        $display("  Phase 2: duty=64 (25%%)");
        duty = 8'd64;
        cycle_count = 0;
        high_count = 0;
        #200;  // Wait for duty change
        measuring = 1;

        // Run for 1 complete PWM period (256 cycles = 25.6us)
        #25600;
        measuring = 0;

        measured_duty = (cycle_count > 0) ? (high_count * 100.0 / cycle_count) : 0.0;
        $display("    Measured: %0d high cycles out of %0d cycles (%.2f%%)",
                 high_count, cycle_count, measured_duty);

        if (measured_duty >= 24.0 && measured_duty <= 26.0) begin
            $display("    PASS: Phase 2 duty cycle within tolerance (24-26%%)");
        end else begin
            $display("    FAIL: Phase 2 duty cycle %.2f%% out of range", measured_duty);
            test_failures = test_failures + 1;
        end
        $display("");

        // ========================================
        // Final Result
        // ========================================
        $display("=== PWM Generator Testbench Complete ===");
        $display("");

        if (test_failures == 0) begin
            $display("TEST_RESULT: PASS - All 7 test cases passed");
        end else begin
            $display("TEST_RESULT: FAIL - %0d test case(s) failed", test_failures);
        end

        $finish;
    end

    // Watchdog timer
    initial begin
        #500000;  // 500us timeout
        $display("ERROR: Testbench timeout after 500us!");
        $display("TEST_RESULT: FAIL - Timeout");
        $finish;
    end

endmodule
